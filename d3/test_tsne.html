<head>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src='https://raw.githack.com/karpathy/tsnejs/master/tsne.js'></script>
</head>

<body>


<script type="text/javascript">
var opt = {epsilon: 10}; // epsilon is learning rate (10 = default)
var tsne = new tsnejs.tSNE(opt); // create a tSNE instance
 

var dropdownChange = function(){
			var new_kmer = d3.select(this).property('value'),
					newfile = './data/dist_matrix/'+new_kmer+'.csv'
					update_tsne(newfile)
}

var update_tsne = function(filename) {
	d3.csv(filename, function(data) {
			var dists = data.map(obj => Object.values(obj));
			tsne.initDataDist(dists);
			for(var k = 0; k < 1000; k++) {
  			tsne.step(); // every time you call this, solution gets better
			}
			var Y = tsne.getSolution(); 
		
			draw_tsne(Y)
	})
}

var dropdown = d3.select("body")
				.insert("select", "svg")
				.on("change",dropdownChange);

var kmerValues = ['AACAA','AACAC','AACAG','AACAT','AACCA','AACCC']
console.log(kmerValues)
dropdown.selectAll('option')
				.data(kmerValues)
			.enter().append('option')
				.attr('value', function(d) {return d; })
				.text(function(d) {return d; });
		var initialData = './data/dist_matrix/AACCC.csv'
		update_tsne(initialData)


d3.csv('./data/boxplot_data.csv', function(data) {

		draw_boxplot(data)
})


function draw_tsne(position) {
		var width = 600;
		var height = 600;
		var padding = 45;
		
		d3.select('#tsne').remove()
		var svg = d3.select('body')
				.append('svg')
				.attr("width", width)
        .attr("height", height)
				.attr("id", "tsne")		

		var xScale = d3.scaleLinear()
				.domain(d3.extent(position, function(d) {return d[0];	}))	
				.range([padding,width - padding * 2])
				.nice();

		var yScale = d3.scaleLinear()
				.domain(d3.extent(position, function(d) {return d[1]; }))
				.range([height - padding, padding])
				.nice();  

		svg.selectAll('circle')
			  .data(position)
			  .enter()
			  .append('circle')
				.attr('x', function(d) {
						return xScale(d[0]);
				})	
				.attr('y', function(d) {
						return yScale(d[1]);
				})
				.attr('r', 4)
				.attr('cx', function(d) {
						return xScale(d[0]);
				})
				.attr('cy', function(d) {
						return yScale(d[1]);
				}); 			 
}


function draw_boxplot(data) {
		var w = 550
		var h = 500

		var margin = {
    top: 20,
    bottom: 20,
    left: 20,
    right: 30
  }

	d3.select('body')
    .append('svg')
    .attr('height', h)
    .attr('width', w)

	var catVariable = 'order'
	var catValues = data.map(d => Number(d[catVariable]))
	var kmerValues = data.map(d => d['kmer'])

	const minVariable = 'min'
  const maxVariable = 'max'
  const medianVariable = 'median'
  const q1Variable = 'q1'
  const q3Variable = 'q3'

	var xScale = d3.scaleLinear()
			.domain([0,5000])
			.range([margin.left, w- margin.right-50])

	/*var yScale = d3.scaleLinear()
			.domain([
				Number(d3.max(data, d => d[catVariable])) + 1,
				Number(d3.min(data, d => d[catVariable])) - 1
			])
			.range([h - margin.bottom, margin.top])	
  */
	
	var yScale = d3.scalePoint()
			.domain(kmerValues)
			.range([h - margin.bottom, margin.top])

	var xAxis = d3.axisBottom()
								.scale(xScale)
								.ticks(10)
								.tickSize(-470)
				
	d3.select('svg')
		.append('g')
		.attr('transform', 'translate(0,480)')
		.attr('id', 'xAxisG')
		.call(xAxis)

	var yAxis = d3.axisRight()
								.scale(yScale)
								.tickSize(-470)
    						//.tickValues(catValues)
								//.tickValues(kmerValues)
								
	
	d3.select('svg')
		.append('g')
		.attr('transform', 'translate(470,0)')
		.attr('id', 'yAxisG')
		.call(yAxis)

	d3.select('svg')
		.selectAll('g.box')
		.data(data)
		.enter()
		.append('g')
		.attr('class', 'box')
		.attr(
			'transform', d => `translate(${xScale(d[medianVariable])},${yScale(d['kmer'])})`
		)

		.each(function(d, i) {
			d3.select(this)
				.append('line')
				.attr('class', 'range')
				.attr('x1', xScale(d[maxVariable]) - xScale(d[medianVariable]))
        .attr('x2', xScale(d[minVariable]) - xScale(d[medianVariable]))
        .attr('y1', 0)
        .attr('y2', 0)
        .style('stroke', 'black')
        .style('stroke-width', '3px')

			d3.select(this)
        .append('line')
        .attr('class', 'max')
        .attr('x1', xScale(d[maxVariable]) - xScale(d[medianVariable]))
        .attr('x2', xScale(d[maxVariable]) - xScale(d[medianVariable]))
        .attr('y1', -10)
        .attr('y2', 10)
        .style('stroke', 'black')
        .style('stroke-width', '3px')			

			d3.select(this)
				.append('line')
        .attr('class', 'min')
        .attr('x1', xScale(d[minVariable]) - xScale(d[medianVariable]))
        .attr('x2', xScale(d[minVariable]) - xScale(d[medianVariable]))
        .attr('y1', -10)
        .attr('y2', 10)
        .style('stroke', 'black')
        .style('stroke-width', '3px')

			d3.select(this)
        .append('rect')
        .attr('class', 'range')
        .attr('x', xScale(d[q1Variable]) - xScale(d[medianVariable]))
        .attr('y', -10)
        .attr('height', 20)
        .attr('width', xScale(d[q3Variable]) - xScale(d[q1Variable]))
        .style('fill', 'white')
        .style('stroke', 'black')
        .style('stroke-width', '3px')

			d3.select(this)
        .append('line')
        .attr('x1', 0)
        .attr('x2', 0)
        .attr('y1', -10)
        .attr('y2', 10)
        .style('stroke', 'darkgray')
        .style('stroke-width', '4px')


		})

		


}



</script>
</body>
